# 一、项目定位与需求

**项目定位**：分布式 IM 系统，支持多设备同步，功能简化但架构完整，类似 Telegram 的核心体验。

## 必须实现的功能（MVP）

1. **用户体系**
   - 注册、登录（手机号/邮箱 + 验证码或密码）
   - 多设备登录（消息同步、游标管理）
   - 好友关系管理（添加/删除好友）
2. **消息系统**
   - 单聊：点对点可靠消息、离线补偿
   - 群聊：小规模群聊（≤200人）
   - 消息类型：文本、图片、文件
   - 消息属性：已读/未读、撤回、漫游消息
3. **多设备同步**
   - `seq_id + 游标(cursor)` 机制
   - 离线消息拉取
4. **推送**
   - 移动端：FCM / APNs
   - Web / 桌面端：WebSocket 长连接
5. **搜索（可选）**
   - 基于 PostgreSQL 全文检索
   - OpenSearch / Elasticsearch 作为升级选项

------

# 二、非功能性需求

- 高可用：单节点宕机不影响服务
- 可扩展：从 1 万用户扩展到 100 万
- 安全性：TLS 加密，消息存储加密
- 可观测性：日志、监控指标（Prometheus + Grafana）

------

# 三、系统架构（C++ 微服务 + 分布式）

```
Clients (Flutter/Qt)
   ↕ (WebSocket / gRPC)
Gateway Layer (C++): 长连接管理、心跳、协议解析、鉴权、路由
   ↕ (gRPC / Kafka)
Microservices (C++):
 - User Service: 账号/设备/好友管理
 - Msg Service: 单聊/群聊/消息存储、seq_id分配、离线补偿
 - File Service: 文件/图片存储（MinIO/S3）
 - Push Service: 移动推送(Firebase/APNs)
Storage:
 - PostgreSQL: 用户/好友/群组/会话元信息
 - Redis: 会话缓存、未读计数、短期消息缓存
 - Kafka: 消息总线（解耦写入与分发）
Infra:
 - Prometheus/Grafana, ELK, CI/CD, Docker/K8s
```

------

# 四、关键技术方案（C++ 可行实现）

1. **通信协议**：
   - 服务间：gRPC + Protobuf
   - 客户端：WebSocket（二进制 / JSON）
2. **消息存储与同步**
   - 消息全局唯一 ID（雪花 ID）
   - `seq_id` 按会话递增，设备游标记录已读/已接收
   - 幂等策略：client_msg_id 防止重复写入
3. **消息流**
   - 客户端 → Gateway → Msg Service → 持久化 → 消费/推送 → 客户端
   - 未在线设备通过游标拉取离线消息
4. **群聊（≤200人）**
   - seq_id 按 group_id 生成
   - 小群可以 fan-out-on-write：写入时直接下发到所有在线设备
5. **缓存**
   - Redis 保存未读计数、session 状态、短期消息
   - Hot message 缓存可加快拉取
6. **对象存储**
   - 文件/图片上传到 MinIO/S3
   - 返回 URL，消息 payload 存储引用
7. **消息队列**
   - Kafka/NATS 用于消息分发、异步推送
   - 可回放、支持多消费者（审计、索引）
8. **监控与运维**
   - Prometheus/Grafana，ELK 日志分析
   - Docker 容器化 + K8s 部署
   - 服务健康检查 + 自动伸缩

------

# 五、迭代计划（里程碑）

| 里程碑 | 时间  | 内容                                      |
| ------ | ----- | ----------------------------------------- |
| M1     | 2–3周 | 用户服务 + Gateway 层（长连接/心跳/路由） |
| M2     | 3–4周 | 单聊（消息存储、未读/已读、离线补偿）     |
| M3     | 3–4周 | 群聊（≤200人） + 简单搜索                 |
| M4     | 2–3周 | 文件传输（MinIO/S3） + 移动端推送         |
| M5     | 收尾  | 部署（Docker/K8s） + 监控 + 文档 & Demo   |

------

# 六、总结

- 架构清晰、职责分明：Gateway + User/Msg/File/Push 微服务
- MVP 可用 PostgreSQL + Redis + MinIO + WebSocket + gRPC 完成
- 后续可引入 Kafka、Cassandra/Scylla、OpenSearch 做性能/规模升级
- 项目既能展示分布式 IM 核心功能，又能用 C++ 完全实现

------

# 七、架构图

```
                            ┌─────────────────────┐
                            │     Clients         │
                            │---------------------│
                            │Flutter / Qt / Web   │
                            │功能: 登录/聊天/群聊│
                            └─────────┬──────────┘
                                      │
                       WebSocket / gRPC (Protobuf)
                                      │
                      ┌───────────────┴───────────────┐
                      │       Gateway 层 (C++)       │
                      │-------------------------------│
                      │ - 长连接管理 (WebSocket)       │
                      │ - 心跳 & 离线检测             │
                      │ - 协议解析 / 鉴权            │
                      │ - 请求路由到后端服务          │
                      └───────┬───────────┬──────────┘
                              │           │
                       gRPC    │           │ Kafka/NATS (可选)
                              │           │
          ┌───────────────────┘           └───────────────────┐
          │                                               │
┌───────────────────┐                         ┌───────────────────┐
│  User Service (C++)│                         │  Msg Service (C++)│
│-------------------│                         │-------------------│
│ - 注册/登录        │                         │ - 单聊/群聊        │
│ - 设备管理         │                         │ - 消息存储         │
│ - 好友关系         │                         │ - seq_id 分配      │
│ - 黑名单/权限管理   │                         │ - 离线消息 & 游标  │
└─────────┬─────────┘                         └─────────┬─────────┘
          │                                           │
          │                                           │
 ┌────────┴────────┐                        ┌─────────┴─────────┐
 │ PostgreSQL (用户/│                        │  Redis (缓存/未读)│
 │ 好友/群/元数据) │                        │  session 状态     │
 └─────────────────┘                        └───────────────────┘
          │                                           │
          │                                           │
 ┌────────┴────────┐                        ┌─────────┴─────────┐
 │ File Service(C++)│                        │ Object Storage    │
 │ - 上传/下载      │                        │ MinIO / S3        │
 │ - URL 引用管理   │                        │ 图片/文件存储     │
 └─────────────────┘                        └───────────────────┘
          │
          │
 ┌────────┴────────┐
 │ Push Service(C++)│
 │ - FCM / APNs     │
 │ - 离线推送/通知  │
 └─────────────────┘

                  Infra & 运维层
 ┌──────────────────────────────────────────┐
 │ - Kafka/NATS 消息总线                     │
 │ - Prometheus / Grafana 监控              │
 │ - ELK / Loki 日志分析                     │
 │ - Docker / Kubernetes 部署               │
 │ - CI/CD Pipeline                          │
 └──────────────────────────────────────────┘
```

# 图解说明

1. **客户端**
   - Flutter/Qt/Web，负责用户交互。
   - 支持 WebSocket 长连接收发消息，也可以通过 gRPC 调用服务 API。
2. **Gateway 层 (C++)**
   - 统一管理所有客户端连接，做鉴权、协议解析、心跳检测。
   - 路由消息到对应后端服务（User/Msg/File/Push）。
3. **User Service**
   - 管理用户信息、好友关系、设备列表、黑名单等元数据。
   - 数据存储 PostgreSQL。
4. **Msg Service**
   - 核心消息服务，管理单聊、群聊、seq_id、游标、离线消息。
   - Redis 用于缓存活跃会话、未读计数、快速拉取消息。
   - 支持消息分发到在线设备，离线消息存储等待设备上线拉取。
5. **File Service + Object Storage**
   - 文件/图片上传、管理 URL 引用。
   - MinIO / S3 存储二进制内容。
6. **Push Service**
   - 处理移动端 FCM/APNs 推送，保证离线消息通知。
7. **消息总线（Kafka/NATS）**
   - 用于解耦 Msg Service 写入和分发，支持异步广播、审计、索引。
8. **Infra & 运维层**
   - 监控（Prometheus/Grafana）、日志分析（ELK/Loki）、容器化部署（Docker/K8s）、CI/CD。

------

