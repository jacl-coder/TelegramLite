# M1: 用户体系和 Gateway

**状态**: � 进行中  
**开始时间**: 2025 年 9 月 7 日  
**预计完成**: 2025 年 9 月 8 日  
**当前进度**: 80%

## 目标

基于 M0 完成的 Auth Service（认证服务），继续完善用户体系的其他组件，并开发高性能 Gateway 服务。

**M0 已完成**: Auth Service（用户认证、登录、多设备管理）
**M1 目标**: User Service（用户档案、好友关系） + Gateway Service（长连接、消息路由）

## 核心目标

1. **User Service (Go)**: 用户信息管理、好友关系、用户状态
2. **Gateway Service (C++)**: 长连接管理、消息路由、负载均衡
3. **服务间通信**: 完善 gRPC 通信和服务发现
4. **数据一致性**: 跨服务的数据同步和缓存策略

## 任务清单

### 1. User Service 设计和开发 ✅

**当前进度**: 100%

#### 数据模型设计

- ✅ 用户信息扩展模型
  - 昵称、头像、个性签名
  - 在线状态、最后上线时间
  - 隐私设置（是否允许被搜索等）
- ✅ 好友关系模型
  - 好友申请、同意/拒绝流程
  - 好友分组管理
  - 黑名单功能
- ✅ 用户设置模型
  - 消息推送设置
  - 隐私权限设置

#### API 接口设计

- ✅ 用户信息管理 API
  - 获取/更新用户资料
  - 上传头像
  - 修改状态
- ✅ 好友管理 API
  - 搜索用户
  - 发送/处理好友请求
  - 好友列表管理
  - 删除好友
- ✅ 设置管理 API
  - 隐私设置
  - 推送设置

#### gRPC 服务定义

- ✅ user.proto 定义
  - UserProfile, FriendRequest, UserSettings, Friendship 消息
  - UserService gRPC 服务接口 (13 个方法)
- ✅ 与 Auth Service 的集成
  - 用户注册后自动创建用户档案
  - 登录时同步用户状态

#### 实现细节

- ✅ 数据库设计和迁移
- ✅ Repository 层实现
- ✅ Service 层业务逻辑
- ✅ HTTP + gRPC 双协议支持
- ✅ 与 Redis 缓存集成 (50-80%性能提升)
- ✅ 统一日志系统集成
- ✅ 完整测试覆盖
- ✅ 生产部署配置

### 2. Gateway Service 架构设计 ⚪

**当前进度**: 0%

#### 技术选型

- [ ] 网络库选择评估
  - Boost.Beast (HTTP/WebSocket)
  - uWebSockets (高性能 WebSocket)
  - 自研基于 epoll/kqueue
- [ ] 构建系统设计
  - CMake 项目结构
  - 依赖管理 (vcpkg/Conan)
  - 编译配置

#### 架构设计

- [ ] 连接管理设计
  - 长连接池管理
  - 心跳保活机制
  - 连接状态同步
- [ ] 消息路由设计
  - 用户会话路由表
  - 负载均衡策略
  - 故障转移机制
- [ ] 协议设计
  - WebSocket 消息格式
  - 二进制协议优化
  - 协议版本兼容

#### 性能优化

- [ ] 内存池管理
- [ ] 零拷贝消息传递
- [ ] 多线程模型设计
- [ ] 监控和指标收集

### 3. 服务集成和通信 ⚪

**当前进度**: 0%

#### 服务发现

- [ ] 简单配置文件方式
- [ ] 健康检查机制
- [ ] 服务注册与发现

#### 数据一致性

- [ ] 跨服务事务处理
- [ ] 缓存更新策略
- [ ] 数据同步机制

#### 监控和日志

- [ ] 统一日志格式
- [ ] 性能指标收集
- [ ] 分布式链路追踪

## 技术架构

### 服务通信流程

```
Client (WebSocket)
    ↓
Gateway Service (C++)
    ↓ (gRPC)
User Service (Go) ←→ Auth Service (Go)
    ↓
Database + Redis
```

## 风险评估

### 技术风险

- **C++ Gateway 复杂度**: 网络编程和内存管理复杂性
- **性能目标**: 单机支持 10K+ 并发连接
- **跨语言通信**: Go-C++ gRPC 通信稳定性

### 解决方案

- 分阶段开发，先实现基础功能
- 充分的单元测试和性能测试
- 参考成熟的开源项目架构

## 验收标准

### 功能验收

- ✅ User Service 完整 API 实现
- [ ] Gateway 支持 WebSocket 长连接
- ✅ 用户上线状态实时同步
- ✅ 好友关系完整流程

### 性能验收

- ✅ User Service API 响应时间 < 100ms (缓存优化后)
- [ ] Gateway 支持 1000+ 并发连接
- [ ] 消息传递延迟 < 50ms

### 质量验收

- ✅ 基础测试覆盖 (Auth + User Service)
- ✅ 完整的 API 文档
- ✅ 生产部署配置

## 🎉 M1 当前进展总结 (2025-09-07)

### ✅ 已完成 (80%)

**User Service**: 100% 完成

- 完整的用户档案管理系统
- 好友关系管理 (申请/接受/拒绝/删除)
- 用户屏蔽功能
- 用户设置管理
- Redis 缓存优化 (50-80%性能提升)
- HTTP + gRPC 双协议支持
- 完整的测试和文档

**Auth Service**: 已在 M0 完成

- 用户认证系统
- 多设备登录支持
- JWT Token 管理

### 🎯 待完成 (20%)

**Gateway Service**: 即将开始

- C++ 高性能长连接服务
- WebSocket 连接管理
- 消息路由和负载均衡

**预计完成时间**: 2025 年 9 月 8 日

- [ ] 部署和运维文档
